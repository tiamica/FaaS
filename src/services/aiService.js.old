import { africanCountries, africanKeywords } from '../data/africanCountries.js';

class AIService {
    constructor() {
        this.apiKey = null; // DeepSeek API key - set in initialize method
        this.baseURL = 'https://api.deepseek.com/v1';
        this.model = 'deepseek-chat'; // Free model available
        this.useRealAI = false; // Set to true when you have API key
    }

    // Initialize with API key
    initialize(apiKey) {
        if (apiKey) {
            this.apiKey = apiKey;
            this.useRealAI = true;
            console.log('DeepSeek AI API initialized');
        } else {
            console.log('Running in simulation mode - add DeepSeek API key for real AI responses');
        }
    }

    async generateResponse(query) {
        try {
            if (this.useRealAI && this.apiKey) {
                return await this.queryDeepSeekAPI(query);
            } else {
                // Fallback to simulated responses
                return await this.generateSimulatedResponse(query);
            }
        } catch (error) {
            console.error('AI Service error:', error);
            return await this.generateSimulatedResponse(query);
        }
    }

    async queryDeepSeekAPI(query) {
        const response = await fetch(`${this.baseURL}/chat/completions`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${this.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: this.model,
                messages: [
                    {
                        role: "system",
                        content: `You are Fourier Analytics AI Search, the most intelligent search engine for Africa. 
                        Always provide positive, business-focused information about African countries. 
                        Focus on growth opportunities, innovation, success stories, and economic potential.
                        Be encouraging and highlight the strengths and achievements of African nations.
                        Keep responses informative but uplifting.`
                    },
                    {
                        role: "user",
                        content: this.createPrompt(query)
                    }
                ],
                max_tokens: 1000,
                temperature: 0.7,
                stream: false
            })
        });

        if (!response.ok) {
            throw new Error(`DeepSeek API error: ${response.status}`);
        }

        const data = await response.json();
        const aiResponse = data.choices[0].message.content;
        
        const relatedCountries = this.findRelatedCountries(query.toLowerCase());
        const sources = this.findRelevantSources(query.toLowerCase());

        return {
            answer: aiResponse,
            relatedCountries: relatedCountries,
            sources: sources
        };
    }

    async generateSimulatedResponse(query) {
        // Simulate API delay
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        const lowerQuery = query.toLowerCase();
        const relatedCountries = this.findRelatedCountries(lowerQuery);
        
        // Generate positive, business-focused response
        const response = this.createPositiveResponse(query, relatedCountries);
        
        return {
            answer: response,
            relatedCountries: relatedCountries,
            sources: this.findRelevantSources(lowerQuery)
        };
    }

    createPrompt(query) {
        return `Please provide a positive, business-focused response about: "${query}"
        
        Requirements:
        - Focus on African opportunities and success stories
        - Highlight specific countries when relevant
        - Emphasize growth, innovation, and potential
        - Keep it informative but uplifting
        - Mention specific sectors and achievements
        - Be encouraging for investment and partnerships
        
        Please structure your response to be engaging and professional.`;
    }

    findRelatedCountries(query) {
        const related = new Set();
        
        // Check for country names
        africanCountries.forEach(country => {
            if (query.includes(country.name.toLowerCase())) {
                related.add(country);
            }
        });
        
        // Check for keywords
        Object.entries(africanKeywords).forEach(([keyword, countries]) => {
            if (query.includes(keyword)) {
                countries.forEach(countryName => {
                    const country = africanCountries.find(c => c.name === countryName);
                    if (country) related.add(country);
                });
            }
        });
        
        // If no specific countries found, return top African innovators
        if (related.size === 0) {
            return africanCountries.slice(0, 3);
        }
        
        return Array.from(related);
    }

    createPositiveResponse(query, countries) {
        const businessThemes = [
            "showing remarkable growth and innovation in",
            "leading the continent in business development and",
            "demonstrating exceptional progress in",
            "pioneering new opportunities in",
            "showcasing Africa's potential through"
        ];
        
        const successStories = [
            "with impressive success stories emerging across the continent",
            "demonstrating Africa's rising economic influence",
            "highlighting the continent's innovative spirit",
            "showcasing the dynamic business environment",
            "reflecting Africa's rapid digital transformation"
        ];
        
        const theme = businessThemes[Math.floor(Math.random() * businessThemes.length)];
        const story = successStories[Math.floor(Math.random() * successStories.length)];
        
        let response = `Africa is ${theme} ${query} ${story}. `;
        
        if (countries.length > 0) {
            response += `This is particularly evident in countries like ${countries.map(c => c.name).join(', ')} `;
            response += `where innovation meets opportunity across various sectors including `;
            
            const sectors = new Set();
            countries.forEach(country => {
                country.keySectors.forEach(sector => sectors.add(sector));
            });
            
            response += Array.from(sectors).slice(0, 4).join(', ');
            response += ". ";
        }
        
        response += "The African continent continues to demonstrate remarkable resilience, innovation, and tremendous growth potential, making it an ideal destination for strategic investment and transformative partnership opportunities. Emerging markets across Africa are creating new pathways for sustainable development and economic prosperity.";
        
        return response;
    }

    findRelevantSources(query) {
        const sources = [
            {
                title: "African Development Bank Group",
                url: "https://www.afdb.org",
                description: "Latest reports on African economic outlook and development"
            },
            {
                title: "Africa Investment Forum",
                url: "https://www.africainvestmentforum.com",
                description: "Investment opportunities and market insights across Africa"
            },
            {
                title: "African Union Development Agency",
                url: "https://www.nepad.org",
                description: "Development initiatives and continental success stories"
            },
            {
                title: "DeepSeek AI",
                url: "https://www.deepseek.com",
                description: "Advanced AI insights powered by DeepSeek technology"
            }
        ];
        
        return sources.slice(0, 3);
    }
}

export default new AIService();
