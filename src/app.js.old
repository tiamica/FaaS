import { SearchBar } from './components/SearchBar.js';
import { SearchResults } from './components/SearchResults.js';
import AIService from './services/aiService.js';

class FourierAnalyticsAISearch {
    constructor() {
        this.searchBar = new SearchBar(this.handleSearch.bind(this));
        this.searchResults = new SearchResults();
        this.isLoading = false;
        
        this.init();
        this.initializeAI();
    }

    init() {
        const appElement = document.getElementById('app');
        
        // Create main layout
        appElement.innerHTML = `
            <div class="main-header">
                ${this.searchBar.element.outerHTML}
            </div>
            <main class="main-content">
                ${this.searchResults.element.outerHTML}
            </main>
            <div class="api-config-modal" id="apiConfigModal">
                <div class="modal-content">
                    <h3>Configure DeepSeek API</h3>
                    <p>Enter your DeepSeek API key to enable real AI responses, or continue with simulated responses.</p>
                    <input type="password" id="apiKeyInput" placeholder="Enter your DeepSeek API key" />
                    <div class="modal-buttons">
                        <button id="saveApiKey" class="btn-primary">Save API Key</button>
                        <button id="useSimulated" class="btn-secondary">Use Simulated Mode</button>
                    </div>
                    <p class="api-help">
                        Get your free API key from <a href="https://platform.deepseek.com/api_keys" target="_blank">DeepSeek Platform</a>
                    </p>
                </div>
            </div>
        `;

        // Re-initialize search bar with proper event listeners
        this.searchBar = new SearchBar(this.handleSearch.bind(this));
        appElement.querySelector('.main-header').innerHTML = '';
        appElement.querySelector('.main-header').appendChild(this.searchBar.element);

        this.setupApiConfigModal();
    }

    initializeAI() {
        // Check if API key is stored in localStorage
        const savedApiKey = localStorage.getItem('deepseek_api_key');
        if (savedApiKey) {
            AIService.initialize(savedApiKey);
            this.hideApiConfigModal();
        } else {
            this.showApiConfigModal();
        }
    }

    setupApiConfigModal() {
        const modal = document.getElementById('apiConfigModal');
        const saveButton = document.getElementById('saveApiKey');
        const simulatedButton = document.getElementById('useSimulated');
        const apiKeyInput = document.getElementById('apiKeyInput');

        saveButton.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem('deepseek_api_key', apiKey);
                AIService.initialize(apiKey);
                this.hideApiConfigModal();
                this.showNotification('DeepSeek API configured successfully!', 'success');
            } else {
                this.showNotification('Please enter a valid API key', 'error');
            }
        });

        simulatedButton.addEventListener('click', () => {
            this.hideApiConfigModal();
            this.showNotification('Running in simulated mode - AI responses are generated locally', 'info');
        });

        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.hideApiConfigModal();
            }
        });
    }

    showApiConfigModal() {
        const modal = document.getElementById('apiConfigModal');
        modal.style.display = 'flex';
    }

    hideApiConfigModal() {
        const modal = document.getElementById('apiConfigModal');
        modal.style.display = 'none';
    }

    showNotification(message, type = 'info') {
        // Remove existing notification
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <span>${message}</span>
            <button class="notification-close">&times;</button>
        `;

        notification.querySelector('.notification-close').addEventListener('click', () => {
            notification.remove();
        });

        document.body.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    async handleSearch(query) {
        if (this.isLoading) return;
        
        this.isLoading = true;
        this.searchBar.setLoading(true);
        this.searchResults.showLoading();

        try {
            const results = await AIService.generateResponse(query);
            this.searchResults.displayResults(results);
        } catch (error) {
            console.error('Search error:', error);
            this.searchResults.showError('Unable to generate response. Please try again.');
            this.showNotification('Error generating response. Using simulated data.', 'error');
        } finally {
            this.isLoading = false;
            this.searchBar.setLoading(false);
        }
    }
}

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new FourierAnalyticsAISearch();
});

// Display welcome message on initial load
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const welcomeQuery = "business opportunities and innovation in Africa";
        AIService.generateResponse(welcomeQuery).then(results => {
            const searchResults = document.querySelector('.results-container');
            if (searchResults && !searchResults.querySelector('.ai-response').innerHTML.includes('response-bubble')) {
                const resultsComponent = new SearchResults();
                resultsComponent.displayResults(results);
                document.querySelector('.results-container').innerHTML = resultsComponent.element.innerHTML;
            }
        });
    }, 1000);
});
